<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SportPlan</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0d0f14; --surface: #161920; --surface2: #1e2230;
    --border: #2a2f40; --accent: #e8f040; --accent2: #40e8c0;
    --text: #f0f2f8; --muted: #6b7280; --green: #22c55e; --red: #ef4444;
    --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }

  /* ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê */
  #authScreen { display: none; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
  .auth-card {
    width: 100%; max-width: 400px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 20px; padding: 40px; position: relative; overflow: hidden;
  }
  .auth-card::before {
    content: ''; position: absolute; top: -60px; right: -60px; width: 180px; height: 180px;
    border-radius: 50%; background: radial-gradient(circle, rgba(232,240,64,0.08) 0%, transparent 70%); pointer-events: none;
  }
  .auth-logo { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 4px; color: var(--accent); margin-bottom: 4px; }
  .auth-logo span { color: var(--text); }
  .auth-tagline { color: var(--muted); font-size: 13px; margin-bottom: 28px; }
  .auth-tabs { display: flex; margin-bottom: 24px; background: var(--surface2); border-radius: 8px; padding: 4px; gap: 0; }
  .auth-tab {
    flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 500;
    color: var(--muted); border-radius: 6px; transition: all 0.15s; border: none; background: none; font-family: 'DM Sans', sans-serif;
  }
  .auth-tab.active { background: var(--accent); color: #0d0f14; }
  .auth-form { display: flex; flex-direction: column; gap: 14px; }
  .auth-error { color: var(--red); font-size: 13px; text-align: center; min-height: 18px; }
  .auth-submit {
    width: 100%; padding: 12px; background: var(--accent); color: #0d0f14;
    border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.15s; margin-top: 4px;
  }
  .auth-submit:hover { background: #d4dc30; transform: translateY(-1px); }
  .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .auth-reconfigure {
    text-align: center; margin-top: 16px; font-size: 12px; color: var(--muted); cursor: pointer; text-decoration: underline;
  }
  .auth-reconfigure:hover { color: var(--text); }

  /* ‚ïê‚ïê APP ‚ïê‚ïê */
  #app { display: none; }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px 28px; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: var(--bg); z-index: 100;
  }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 3px; color: var(--accent); }
  .logo span { color: var(--text); }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 99px; font-size: 13px; }
  .user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: #0d0f14; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; flex-shrink: 0; }
  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); flex-shrink: 0; transition: background 0.3s; }
  .sync-dot.syncing { background: var(--accent); animation: pulse 1s infinite; }
  .sync-dot.error   { background: var(--red); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .btn { display: inline-flex; align-items: center; gap: 7px; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; transition: all 0.15s; }
  .btn-primary { background: var(--accent); color: #0d0f14; }
  .btn-primary:hover { background: #d4dc30; }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { background: var(--border); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
  .btn-danger:hover { background: rgba(239,68,68,0.08); }

  .progbar-wrap { display: flex; align-items: center; gap: 14px; padding: 9px 28px; border-bottom: 1px solid var(--border); }
  .progbar-label { font-size: 11px; color: var(--muted); white-space: nowrap; }
  .progbar-track { flex: 1; height: 4px; background: var(--surface2); border-radius: 99px; overflow: hidden; }
  .progbar-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); border-radius: 99px; transition: width 0.4s; }
  .progbar-pct { font-size: 11px; font-weight: 600; color: var(--accent); min-width: 34px; text-align: right; }

  .layout { display: flex; height: calc(100vh - 108px); }
  .sidebar { width: 185px; min-width: 185px; border-right: 1px solid var(--border); overflow-y: auto; padding: 12px 0; background: var(--surface); display: flex; flex-direction: column; }
  .sidebar::-webkit-scrollbar { width: 3px; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
  .sb-title { font-size: 10px; font-weight: 600; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; padding: 0 13px 9px; }
  .sb-list { flex: 1; overflow-y: auto; }
  .week-btn { display: flex; align-items: center; justify-content: space-between; padding: 8px 13px; cursor: pointer; font-size: 13px; color: var(--muted); border-left: 3px solid transparent; transition: all 0.12s; }
  .week-btn:hover { background: var(--surface2); color: var(--text); }
  .week-btn.active { background: rgba(232,240,64,0.06); color: var(--accent); border-left-color: var(--accent); }
  .wdot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); flex-shrink: 0; }
  .wdot.done { background: var(--green); } .wdot.part { background: var(--accent); }
  .add-week-btn { padding: 9px 13px; background: transparent; border: none; border-top: 1px dashed var(--border); color: var(--muted); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 12px; text-align: left; transition: all 0.12s; margin-top: 4px; width: 100%; }
  .add-week-btn:hover { background: var(--surface2); color: var(--text); }

  .content { flex: 1; overflow-y: auto; padding: 26px 30px; }
  .content::-webkit-scrollbar { width: 5px; }
  .content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

  .week-hdr { margin-bottom: 22px; }
  .week-hdr h1 { font-family: 'Bebas Neue', sans-serif; font-size: 42px; letter-spacing: 2px; line-height: 1; }
  .week-hdr h1 span { color: var(--accent); }
  .week-hdr p { color: var(--muted); font-size: 12px; margin-top: 4px; }
  .wstats { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
  .stat-chip { display: flex; align-items: center; gap: 5px; padding: 4px 11px; background: var(--surface); border: 1px solid var(--border); border-radius: 99px; font-size: 11px; }
  .chip-dot { width: 6px; height: 6px; border-radius: 50%; }

  .table-wrap { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--surface2); }
  th { padding: 11px 16px; text-align: left; font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); }
  th.th-valid { text-align: center; width: 130px; }
  tr.sep td { border-top: 1px solid var(--border); padding: 0; }
  tr.ex-row td { border-bottom: none; padding: 11px 16px; vertical-align: middle; font-size: 14px; }
  td.td-day { font-weight: 600; color: var(--accent2); white-space: nowrap; font-size: 13px; width: 110px; vertical-align: middle; border-right: 1px solid var(--border); background: var(--surface) !important; }
  td.td-day span { outline: none; display: block; }
  td.td-day span:focus { background: var(--surface2); border-radius: 4px; padding: 2px 4px; margin: -2px -4px; }
  td.td-prog { color: var(--text); line-height: 1.5; }
  .prog-inner { display: flex; align-items: center; gap: 8px; }
  .ex-bullet { color: var(--accent); font-size: 10px; flex-shrink: 0; opacity: 0.5; }
  span.ex-name { outline: none; flex: 1; }
  span.ex-name:focus { background: var(--surface2); border-radius: 4px; padding: 1px 4px; margin: -1px -4px; }
  td.td-valid { text-align: center; width: 130px; }
  .val-wrap { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
  .val-input { width: 44px; padding: 6px 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; text-align: center; outline: none; transition: border 0.15s; }
  .val-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(232,240,64,0.1); }
  .val-badge { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 6px; font-size: 13px; flex-shrink: 0; }
  .val-badge.ok  { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
  .val-badge.ko  { background: rgba(239,68,68,0.15);  color: var(--red);   border: 1px solid rgba(239,68,68,0.3); }
  .val-badge.empty { opacity: 0; width: 0; overflow: hidden; padding: 0; }
  tr.ex-row.v-ok td { background: rgba(34,197,94,0.04); }
  tr.ex-row.v-ko td { background: rgba(239,68,68,0.04); }

  .add-row-btn { width: 100%; padding: 10px 16px; background: transparent; border: none; border-top: 1px dashed var(--border); color: var(--muted); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 12px; text-align: left; transition: all 0.12s; }
  .add-row-btn:hover { background: var(--surface2); color: var(--text); }

  .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 16px; text-align: center; }
  .empty-icon { font-size: 52px; opacity: 0.3; }
  .empty-state h2 { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 2px; color: var(--muted); }
  .empty-state p { color: var(--muted); font-size: 13px; max-width: 320px; line-height: 1.6; }
  .empty-btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: 9px; padding: 11px 16px; font-size: 13px; z-index: 9999; transform: translateY(60px); opacity: 0; transition: all 0.25s; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.ok   { border-color: var(--green); color: var(--green); }
  .toast.err  { border-color: var(--red);   color: var(--red); }
  .toast.info { border-color: var(--accent2); color: var(--accent2); }

  #fileInput { display: none; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê √âCRAN D'AUTHENTIFICATION ‚ïê‚ïê -->
<div id="authScreen" style="display:none">
  <div class="auth-card">
    <div class="auth-logo">SPORT<span>PLAN</span></div>
    <div class="auth-tagline">Ton planning sportif, disponible partout</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin"    onclick="switchTab('login')">Se connecter</button>
      <button class="auth-tab"        id="tabRegister" onclick="switchTab('register')">Cr√©er un compte</button>
    </div>
    <div class="auth-form">
      <div>
        <div class="field-label">Nom d'utilisateur</div>
        <input class="field-input" id="authUser" type="text" placeholder="ex: jean_sport" autocomplete="username">
      </div>
      <div>
        <div class="field-label">Mot de passe</div>
        <input class="field-input" id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <div id="authConfirmWrap" style="display:none">
        <div class="field-label">Confirmer le mot de passe</div>
        <input class="field-input" id="authConfirm" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="auth-error" id="authError"></div>
      <button class="auth-submit" id="authBtn" onclick="handleAuth()">Se connecter</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app">
  <header>
    <div class="logo">SPORT<span>PLAN</span></div>
    <div class="header-right">
      <div class="sync-dot" id="syncDot"></div>
      <div class="user-badge">
        <div class="user-avatar" id="userAvatar">?</div>
        <span id="userLabel">‚Äî</span>
      </div>
      <button class="btn btn-ghost" onclick="document.getElementById('fileInput').click()">üìÇ Importer</button>
      <button class="btn btn-primary" onclick="syncSave()">‚òÅÔ∏è Sauvegarder</button>
      <button class="btn btn-danger"  onclick="logout()">D√©connexion</button>
    </div>
  </header>
  <div class="progbar-wrap">
    <span class="progbar-label">Progression globale</span>
    <div class="progbar-track"><div class="progbar-fill" id="gFill" style="width:0%"></div></div>
    <span class="progbar-pct" id="gPct">0%</span>
  </div>
  <div class="layout">
    <div class="sidebar">
      <div class="sb-title">Semaines</div>
      <div class="sb-list" id="sbList"></div>
      <button class="add-week-btn" onclick="addWeek()">+ Ajouter une semaine</button>
    </div>
    <div class="content" id="content">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üèãÔ∏è</div>
        <h2>Aucun planning</h2>
        <p>Importez un fichier Excel ou cr√©ez une semaine manuellement.</p>
        <div class="empty-btns">
          <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üìÇ Importer Excel</button>
          <button class="btn btn-ghost" onclick="addWeek()">+ Cr√©er une semaine</button>
        </div>
      </div>
      <div id="weekView" style="display:none"></div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".xlsx,.xls" onchange="onImport(event)">
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE CONFIG
   Stock√©e dans localStorage (sur l'appareil courant)
   Jamais envoy√©e nulle part d'autre
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const SUPABASE_URL = 'https://nntjzvtjogttsyblncsu.supabase.co';
const SUPABASE_KEY = 'sb_publishable_sAU1qKtqj0iv4BZMsoUHlw_xxYB57Xp';
let weeks = [];
let cur = 0;
let currentUser = null;
let authMode = 'login';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
  const savedUser = sessionStorage.getItem('sp_user');
  if (savedUser) {
    currentUser = savedUser;
    loadPlanning().then(() => showApp()).catch(() => showScreen('auth'));
  } else {
    showScreen('auth');
  }
};

function showScreen(name) {
  document.getElementById('authScreen').style.display = name === 'auth' ? 'flex' : 'none';
  document.getElementById('app').style.display        = name === 'app'  ? 'block' : 'none';
}



// ‚îÄ‚îÄ SUPABASE HTTP HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sbFetch(url, key, method, path, body) {
  return fetch((url || SUPABASE_URL) + path, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'apikey': key || SUPABASE_KEY,
      'Authorization': 'Bearer ' + (key || SUPABASE_KEY),
      'Prefer': method === 'POST' ? 'return=representation' : ''
    },
    body: body ? JSON.stringify(body) : undefined
  });
}

async function sbGet(path) {
  const r = await sbFetch(null, null, 'GET', path);
  if (!r.ok) { const e = await r.json(); throw new Error(e.message || e.hint); }
  return r.json();
}

async function sbPost(path, body) {
  const r = await sbFetch(null, null, 'POST', path, body);
  if (!r.ok) { const e = await r.json(); throw new Error(e.message || e.hint); }
  return r.json();
}

async function sbPatch(path, body) {
  const r = await sbFetch(null, null, 'PATCH', path, body);
  if (!r.ok) { const e = await r.json(); throw new Error(e.message || e.hint); }
  return r.status === 204 ? {} : r.json();
}

// ‚îÄ‚îÄ HASH MOT DE PASSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function hashPass(p) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode('sp_salt_' + p));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(mode) {
  authMode = mode;
  document.getElementById('tabLogin').classList.toggle('active', mode === 'login');
  document.getElementById('tabRegister').classList.toggle('active', mode === 'register');
  document.getElementById('authConfirmWrap').style.display = mode === 'register' ? 'block' : 'none';
  document.getElementById('authBtn').textContent = mode === 'login' ? 'Se connecter' : 'Cr√©er mon compte';
  document.getElementById('authError').textContent = '';
}

async function handleAuth() {
  const username = document.getElementById('authUser').value.trim().toLowerCase();
  const password = document.getElementById('authPass').value;
  const confirm  = document.getElementById('authConfirm').value;
  const errEl    = document.getElementById('authError');
  const btn      = document.getElementById('authBtn');

  errEl.textContent = '';
  if (!username || !password) { errEl.textContent = 'Remplis tous les champs.'; return; }
  if (username.length < 3)    { errEl.textContent = 'Nom trop court (min 3 caract√®res).'; return; }
  if (password.length < 4)    { errEl.textContent = 'Mot de passe trop court (min 4 caract√®res).'; return; }
  if (authMode === 'register' && password !== confirm) { errEl.textContent = 'Les mots de passe ne correspondent pas.'; return; }

  btn.disabled = true;
  btn.textContent = '‚è≥ Chargement‚Ä¶';

  try {
    const hashed = await hashPass(password);

    if (authMode === 'register') {
      // V√©rifie si le nom est pris
      const existing = await sbGet(`/rest/v1/users?username=eq.${encodeURIComponent(username)}&select=username`);
      if (existing.length > 0) throw new Error('Ce nom d\'utilisateur est d√©j√† pris.');
      // Cr√©e le compte
      await sbPost('/rest/v1/users', { username, password_hash: hashed, planning: [] });
      currentUser = username;
      weeks = [];
    } else {
      // Connexion
      const rows = await sbGet(`/rest/v1/users?username=eq.${encodeURIComponent(username)}&select=username,password_hash,planning`);
      if (rows.length === 0)              throw new Error('Utilisateur introuvable.');
      if (rows[0].password_hash !== hashed) throw new Error('Mot de passe incorrect.');
      currentUser = username;
      weeks = rows[0].planning || [];
    }

    sessionStorage.setItem('sp_user', currentUser);
    showApp();

  } catch(e) {
    errEl.textContent = e.message || 'Erreur de connexion.';
    btn.disabled = false;
    btn.textContent = authMode === 'login' ? 'Se connecter' : 'Cr√©er mon compte';
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('authScreen').style.display !== 'none') handleAuth();
});

// ‚îÄ‚îÄ LOAD / SAVE PLANNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPlanning() {
  const rows = await sbGet(`/rest/v1/users?username=eq.${encodeURIComponent(currentUser)}&select=planning`);
  if (rows.length === 0) throw new Error('Utilisateur introuvable.');
  weeks = rows[0].planning || [];
}

async function syncSave() {
  try {
    setSyncState('syncing');
    await sbPatch(`/rest/v1/users?username=eq.${encodeURIComponent(currentUser)}`, { planning: weeks });
    setSyncState('ok');
    showToast('Sauvegard√© sur Supabase ‚òÅÔ∏è', 'ok');
  } catch(e) {
    setSyncState('error');
    showToast('Erreur de sauvegarde : ' + e.message, 'err');
  }
}

let autoSaveTimer;
function scheduleAutoSave() {
  clearTimeout(autoSaveTimer);
  setSyncState('syncing');
  autoSaveTimer = setTimeout(async () => {
    try {
      await sbPatch(`/rest/v1/users?username=eq.${encodeURIComponent(currentUser)}`, { planning: weeks });
      setSyncState('ok');
    } catch(e) { setSyncState('error'); }
  }, 2000);
}

function setSyncState(s) {
  const d = document.getElementById('syncDot');
  if (!d) return;
  d.className = 'sync-dot' + (s === 'syncing' ? ' syncing' : s === 'error' ? ' error' : '');
}

// ‚îÄ‚îÄ SHOW APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showApp() {
  showScreen('app');
  document.getElementById('userLabel').textContent = currentUser;
  document.getElementById('userAvatar').textContent = currentUser.charAt(0).toUpperCase();
  setSyncState('ok');
  renderSidebar();
  if (weeks.length) showWeek(0);
}

function logout() {
  currentUser = null; weeks = [];
  sessionStorage.removeItem('sp_user');
  document.getElementById('weekView').style.display = 'none';
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('sbList').innerHTML = '';
  showScreen('auth');
}

// ‚îÄ‚îÄ IMPORT EXCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
      weeks = [];
      for (const sheetName of wb.SheetNames) {
        const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: 1, defval: '' });
        const rows = [];
        for (const r of raw) {
          const day  = String(r[0] || '').trim();
          const prog = String(r[1] || '').trim();
          if (!day && !prog) continue;
          rows.push({ day, exercises: parseExercises(prog) });
        }
        weeks.push({ name: sheetName, rows });
      }
      renderSidebar();
      if (weeks.length) showWeek(0);
      scheduleAutoSave();
      showToast(`${weeks.length} semaine(s) import√©e(s) !`, 'ok');
    } catch(err) { showToast('Erreur import', 'err'); }
  };
  reader.readAsArrayBuffer(file);
  e.target.value = '';
}

function parseExercises(prog) {
  if (!prog) return [{ name: '', valid: '' }];
  if (prog.includes('/')) return prog.split('/').map(s => ({ name: s.trim(), valid: '' }));
  return [{ name: prog, valid: '' }];
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSidebar() {
  const list = document.getElementById('sbList');
  list.innerHTML = '';
  weeks.forEach((w, i) => {
    const { done, total } = weekStats(i);
    const dot = total === 0 ? '' : done === total ? 'done' : done > 0 ? 'part' : '';
    const el = document.createElement('div');
    el.className = 'week-btn' + (i === cur ? ' active' : '');
    el.innerHTML = `<span>${esc(w.name)}</span><div class="wdot ${dot}"></div>`;
    el.onclick = () => showWeek(i);
    list.appendChild(el);
  });
  updateGlobalBar();
}

function weekStats(wi) {
  let done = 0, total = 0;
  for (const row of weeks[wi].rows)
    for (const ex of row.exercises)
      if (ex.name) { total++; if (ex.valid === '1') done++; }
  return { done, total };
}

function updateGlobalBar() {
  let done = 0, total = 0;
  weeks.forEach((_, i) => { const s = weekStats(i); done += s.done; total += s.total; });
  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('gFill').style.width = pct + '%';
  document.getElementById('gPct').textContent = pct + '%';
}

// ‚îÄ‚îÄ SEMAINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showWeek(i) {
  cur = i;
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('weekView').style.display = 'block';
  document.querySelectorAll('.week-btn').forEach((el, j) => el.classList.toggle('active', j === i));
  buildShell(i); renderTbody(i);
}

function buildShell(wi) {
  const w = weeks[wi];
  const { done, total } = weekStats(wi);
  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('weekView').innerHTML = `
    <div class="week-hdr">
      <h1>Semaine <span>${esc(w.name)}</span></h1>
      <p>Entrez <strong>1</strong> pour valider, <strong>0</strong> pour indiquer un rat√©</p>
      <div class="wstats" id="wstats">
        <div class="stat-chip"><div class="chip-dot" style="background:var(--green)"></div>${done}/${total} exercices valid√©s</div>
        <div class="stat-chip"><div class="chip-dot" style="background:var(--accent)"></div>${pct}%</div>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th style="width:110px">Jour</th>
          <th>Programme</th>
          <th class="th-valid">Validation</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <button class="add-row-btn" onclick="addRow(${wi})">Ôºã Ajouter une s√©ance</button>
    </div>
  `;
}

function renderTbody(wi) {
  const tbody = document.getElementById('tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  let first = true;

  weeks[wi].rows.forEach((row, ri) => {
    const exs = row.exercises;
    const multi = exs.length > 1;

    if (!first) {
      const sep = document.createElement('tr'); sep.className = 'sep';
      const td = document.createElement('td'); td.colSpan = 3;
      sep.appendChild(td); tbody.appendChild(sep);
    }
    first = false;

    exs.forEach((ex, ei) => {
      const vClass = ex.valid === '1' ? 'v-ok' : ex.valid === '0' ? 'v-ko' : '';
      const tr = document.createElement('tr');
      tr.className = 'ex-row' + (vClass ? ' ' + vClass : '');

      if (ei === 0) {
        const tdDay = document.createElement('td');
        tdDay.className = 'td-day';
        if (exs.length > 1) tdDay.rowSpan = exs.length;
        const span = document.createElement('span');
        span.contentEditable = 'true'; span.textContent = row.day;
        span.onblur = () => { weeks[wi].rows[ri].day = span.textContent.trim(); scheduleAutoSave(); };
        tdDay.appendChild(span); tr.appendChild(tdDay);
      }

      const tdProg = document.createElement('td'); tdProg.className = 'td-prog';
      const inner = document.createElement('div'); inner.className = 'prog-inner';
      if (multi) { const b = document.createElement('span'); b.className = 'ex-bullet'; b.textContent = '‚ñ∏'; inner.appendChild(b); }
      const nameSpan = document.createElement('span'); nameSpan.className = 'ex-name'; nameSpan.contentEditable = 'true'; nameSpan.textContent = ex.name;
      nameSpan.onblur = () => { weeks[wi].rows[ri].exercises[ei].name = nameSpan.textContent.trim(); scheduleAutoSave(); };
      inner.appendChild(nameSpan); tdProg.appendChild(inner); tr.appendChild(tdProg);

      const tdVal = document.createElement('td'); tdVal.className = 'td-valid';
      const wrap = document.createElement('div'); wrap.className = 'val-wrap';
      const input = document.createElement('input');
      input.className = 'val-input'; input.type = 'text'; input.maxLength = 1; input.value = ex.valid; input.placeholder = '‚Äì';
      input.onkeydown = ev => { if (ev.key === 'Enter') input.blur(); };
      input.oninput = () => onValidInput(wi, ri, ei, input);
      const badge = document.createElement('div');
      badge.className = 'val-badge ' + (ex.valid === '1' ? 'ok' : ex.valid === '0' ? 'ko' : 'empty');
      badge.textContent = ex.valid === '1' ? '‚úî' : ex.valid === '0' ? '‚úñ' : '';
      wrap.appendChild(input); wrap.appendChild(badge); tdVal.appendChild(wrap); tr.appendChild(tdVal);
      tbody.appendChild(tr);
    });
  });
}

function onValidInput(wi, ri, ei, input) {
  const v = input.value.trim();
  if (v !== '0' && v !== '1' && v !== '') { input.value = ''; weeks[wi].rows[ri].exercises[ei].valid = ''; return; }
  weeks[wi].rows[ri].exercises[ei].valid = v;
  let flat = 0;
  for (let r = 0; r < ri; r++) flat += weeks[wi].rows[r].exercises.length;
  flat += ei;
  renderTbody(wi); updateStatsChips(wi); renderSidebar(); scheduleAutoSave();
  const inputs = document.querySelectorAll('#tbody .val-input');
  if (inputs[flat]) inputs[flat].focus();
}

function updateStatsChips(wi) {
  const el = document.getElementById('wstats'); if (!el) return;
  const { done, total } = weekStats(wi);
  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  el.innerHTML = `
    <div class="stat-chip"><div class="chip-dot" style="background:var(--green)"></div>${done}/${total} exercices valid√©s</div>
    <div class="stat-chip"><div class="chip-dot" style="background:var(--accent)"></div>${pct}%</div>
  `;
}

function addWeek() {
  weeks.push({ name: 'S' + (weeks.length + 1), rows: [
    { day: 'Lundi',    exercises: [{ name: '', valid: '' }] },
    { day: 'Mercredi', exercises: [{ name: '', valid: '' }] },
    { day: 'Vendredi', exercises: [{ name: '', valid: '' }] },
  ]});
  renderSidebar(); showWeek(weeks.length - 1); scheduleAutoSave();
}

function addRow(wi) {
  weeks[wi].rows.push({ day: '', exercises: [{ name: '', valid: '' }] });
  renderTbody(wi); updateStatsChips(wi); scheduleAutoSave();
  const days = document.querySelectorAll('#tbody .td-day span');
  if (days.length) days[days.length - 1].focus();
}

document.getElementById('content').addEventListener('dragover', e => e.preventDefault());
document.getElementById('content').addEventListener('drop', e => {
  e.preventDefault();
  const f = e.dataTransfer.files[0];
  if (f && (f.name.endsWith('.xlsx') || f.name.endsWith('.xls')))
    onImport({ target: { files: [f], value: '' } });
});

let _tt;
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type || '');
  clearTimeout(_tt); _tt = setTimeout(() => t.className = 'toast', 3500);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>